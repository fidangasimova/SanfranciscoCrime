---
title: "PROJECT II: San Francisco Crime (2016)"
author: "FH"
date: "December 28, 2020"
---output: html_document
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_meta(clean=T)
```



# Inroduction

The analysis performed within this project is based on a data set entitled San Francisco Crime is available on Kaggle and can be found here:


- https://www.kaggle.com/roshansharma/sanfranciso-crime-dataset 

The original dataset is from https://datasf.org/opendata/, the central clearinghouse for data published by the City and County of San Francisco. The San Francisco Police Department does not guarantee the accuracy, completeness, timeliness or correct sequencing of the information as the data is subject to change as modifications and updates are completed. The complete data set can be found here:


- https://data.sfgov.org/Public-Safety/Police-Department-Incident-Reports-Historical-2003/tmnf-yvry

Due to computation power issues only a subset of the data was used. The algorithms were developed using the **sf_crime** data, which is a subset of the of the SF Opendata and includes only 2016. For the evaluation of the recommendation algorithm a **validation** data set was generated. The **validation** data set was only used in the final step to test the final algorithm and contained only 20% of **sf_crime** data.

The following libraries were used:  

```{r warning= FALSE, include = FALSE}
if(!require(tinytex)) install.packages("tinytex", repos = "http://cran.us.r-project.org")
if(!require(factoextra)) install.packages("factoextra", repos = "http://cran.us.r-project.org")
if(!require(Hmisc)) install.packages("Hmisc", repos = "http://cran.us.r-project.org")
if(!require(dslabs)) install.packages("dslabs", repos = "http://cran.us.r-project.org")
if(!require(tidyr)) install.packages("tidyr", repos = "http://cran.us.r-project.org")
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(stringr)) install.packages("stringr", repos = "http://cran.us.r-project.org")
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(ggplot2)) install.packages("ggplot2", repos = "http://cran.us.r-project.org")
if(!require(lubridate)) install.packages("lubridate", repos = "http://cran.us.r-project.org")
if(!require(corrplot)) install.packages("corrplot", repos = "http://cran.us.r-project.org")
if(!require(data.table)) install.packages("data.table", repos = "http://cran.us.r-project.org")
if(!require(readr)) install.packages("readr", repos = "http://cran.us.r-project.org")
if(!require(gridExtra)) install.packages("gridExtra", repos = "http://cran.us.r-project.org")
if(!require(ggthemes)) install.packages("ggthemes", repos = "http://cran.us.r-project.org")
```


```{r  message=FALSE}
library(tinytex)
library(factoextra)
library(ggthemes)
library(Hmisc)
library(tidyr)
library(dslabs)
library(tidyverse)
library(caret)
library(data.table)
library(corrplot)
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(readr)
library(gridExtra)
```


```{r echo = FALSE}
#  Code to download data 
sf_crime <- read.csv("sf_crime.csv", header=TRUE, sep = ",", row.names = NULL, quote = "\"")

#  Names of columns without spaces
names(sf_crime) <- make.names(names(sf_crime), unique=TRUE)

#  Change the format from scientific to numerical
options(scipen = 999)

#  #  #  #  #  #  #  #  #  #  #  #  #  
#    Data Processing                #  
#  #  #  #  #  #  #  #  #  #  #  #  #  

sf_crime<-as.data.frame(sf_crime, stringsAsFactors=TRUE) %>%
         mutate(IncidntNum = as.numeric(IncidntNum),
                PdId       = as.numeric(PdId),
                Category   = factor(Category, levels = c("MISSING PERSON", "LARCENY/THEFT", "OTHER OFFENSES", "BURGLARY",                   
                                                "SUSPICIOUS OCC","WARRANTS", "ASSAULT","NON-CRIMINAL",               
                                                "STOLEN PROPERTY", "WEAPON LAWS", "DRUG/NARCOTIC","EMBEZZLEMENT",               
                                                "RUNAWAY", "DRUNKENNESS", "FORGERY/COUNTERFEITING","ROBBERY",                     
                                                "VEHICLE THEFT", "FRAUD", "SEX OFFENSES, FORCIBLE", "SECONDARY CODES",            
                                                "KIDNAPPING", "VANDALISM", "PROSTITUTION", "DRIVING UNDER THE INFLUENCE",
                                                "RECOVERED VEHICLE", "SEX OFFENSES, NON FORCIBLE","TRESPASS", "ARSON",                      
                                                "DISORDERLY CONDUCT", "LIQUOR LAWS", "FAMILY OFFENSES","EXTORTION",                  
                                                "BAD CHECKS", "LOITERING", "SUICIDE", "BRIBERY", "GAMBLING","PORNOGRAPHY/OBSCENE MAT", "TREA")),
              Descript    = as.character(Descript) %>% factor(),
              Resolution  = as.character(Resolution),
              DayOfWeek   = factor(DayOfWeek, levels = c("Monday", "Tuesday", "Wednesday",
                                                  "Thursday","Friday", "Saturday", "Sunday")),
               PdDistrict = as.character(PdDistrict))




```

## Data Exploration and Data Processing
The **sf_cime** data set contains 150,500 observations and 13 variables represented in 13 columns. Each row represents one incident with an ID given by the Police Departmen.

```{r }
#  Number of variables
print(ncol(sf_crime))
```

```{r }
#  Number of observations
print(nrow(sf_crime))
```

This data set contains incidents derived from SFPD Crime Incident Reporting system. The data ranges from January to December 2016. The downloaded data set **sf_crime** contains no missing data and consists of following 13 variables: 

- *PdId* - ID given by Police Department District
- *IncidntNum* - ID of th incident
- *Date* - time in mm/dd/yy format
- *Time* - time of the day from 00 to 24 hours
- *Category* - category of the crime incident
- *Descript* - detailed description of the crime incident
- *DayOfWeek* - the day of the week (Mo-Fr)
- *PdDistrict* - name of the Police Department District
- *Resolution* - how the crime incident was resolved 
- *Address* - the approximate street address of the crime incident
- *X* - Longitude
- *Y* - Latitude
- *Location* -  Longitude and Latitude combined in one variable

**sf_crime** contains no missing data.
```{r }
# Check missing values
sum(is.na(sf_crime))
```

In order to visualize and analyze the data set several new variables were created through transformation of existing variables.

The variable *Date* was transformed and split into *Date_Month*, *Date_Day*, *Date_Year*. Variable *Time* was converted into a numerical variable *Time_Hour*. *Resolution_dummy* was created to indicate if the incident resolved equals 1 or not resolved = 0. In order to simplify variable *Category*  a dummy variable *Category_Violent_dummy* was assigned value 1 when "ASSAULT", "ROBBERY", "SEX OFFENSES, FORCIBLE", "KIDNAPPING" and value 0 otherwise. New variable *Count_Address_Occur* indicates how many times incidents took place at the same address. 

```{r echo = FALSE}
#   Convert char variable "Time_Hour" into a numeric variable
hhmm2dec <- function(x) {
  xlist <- strsplit(x,split=":")
  h <- as.numeric(sapply(xlist,"[",1))
  m <- as.numeric(sapply(xlist,"[",2))
  xdec <- h+(m/60)
  return(xdec)
}

#   Round variable "Time_Hour" without minutes
sf_crime$Time_Hour <- round(hhmm2dec(sf_crime$Time), 0)

#  Replace Hours = 24 with Hours = 0
sf_crime$Time_Hour <-replace(sf_crime$Time_Hour, sf_crime$Time_Hour ==24, 0) 

#   Convert "Date" character into class Date
sf_crime <- transform(sf_crime, Date_time = as.Date(Date, "%m/%d/%Y", tz = "UTC"))

#   Create variables "Date_month", "Date_day", "Date_year"
sf_crime<-sf_crime %>% mutate(Date_Month = month(Date_time), 
                              Date_Day   = day(Date_time),
                              Date_Year  = year(Date_time)) %>%
                       mutate(Month = month.name[Date_Month])
                      
#   Convert "Month" variable into an ordered factor                      
sf_crime<- sf_crime %>% mutate(Month = factor(Month, levels = month.name))

# Create new dummy variable "Resolution_dummy" (1 = resolved, 0 = unresolved)
sf_crime$Resolution_dummy <- ifelse(sf_crime$Resolution == "NONE", 0, 1)

# Create a new dummy variable "Category_violent" (1 = violent, 0 = nonviolent)
sf_crime$Category_Violent_dummy <- ifelse (sf_crime$Category %in% c("ASSAULT", "ROBBERY", "SEX OFFENSES, FORCIBLE", "KIDNAPPING"), 1, 0)  

# Create a new variable "Count_Address_Occur" to count the number of Occurrences of Addresses 
sf_crime<- sf_crime %>% group_by(Address) %>%
             mutate(Count_Address_Occur = n(), .groups = 'drop')  %>% ungroup() %>%
             arrange(desc(Count_Address_Occur))  

# Create a new variable "Count_Category_Occur" to count the number of Occurrences of Categories 
sf_crime<- sf_crime %>% group_by(Category) %>%
             mutate(Count_Category_Occur = n(), .groups = 'drop')  %>% ungroup() %>%
             arrange(desc(Count_Category_Occur))  



# Reorder columns of sf_crime data
sf_crime<-sf_crime[, c("PdId",  "IncidntNum", "Category", "Count_Category_Occur", "Category_Violent_dummy", "Descript",  "Resolution","Resolution_dummy", 
                      "DayOfWeek","Date_Day", "Date_Year", "Date_Month", "Month", "Time_Hour", "Date_time",                                                       
                      "PdDistrict", "Address", "Count_Address_Occur", "Y",  "X", "Location")]

# Order the data by increasing incident number "PdId"(police department ID)
sf_crime <- arrange(sf_crime, by = PdId)

```

```{r }
# Summary of the data set
summary(sf_crime)
```

*PdId* is a unique identifier (each incident gets its unique number) whereas *IncidntNum* incident number can be assigned to several incidents that happened during the same crime.
```{r include = FALSE}
# Find duplicates among "IncidntNum"(incident number)
duplicated(sf_crime$IncidntNum)
```

33,801 *IncidntNum* incident numbers have more than one crime category assigned to them.
```{r warning=FALSE}
# Total number of duplicates among "IncidntNum"(incident number)
print(sum(duplicated(sf_crime$IncidntNum)))
```

```{r warning=FALSE}
# Find index of the duplicates among "IncidntNum" (incident ID)
dup <- sf_crime$IncidntNum[duplicated(sf_crime$IncidntNum)]

# Print 10 incident ID's with more than one crime
head(dup, 10) %>% knitr::kable("pipe")
```
The new processed data set contains 21 variables instead of original 13   
```{r warning=FALSE}
# Processed sf_crime data
head(sf_crime, 10) 
```

```{r  warning=FALSE}
#   Description of variables in processed sf_crime
summary(sf_crime)
```

Number of unique incidents is 150,500, crime categories are listed. *Description* of crime includes 726 different descriptions. This variable was mot strictly defined and was up to the police officers to chose the description. 16130 different addresses are present in the data set. There are 10 districts (plus one incident without a district) of Police Department and 14 resolution of crime categories.
```{r warning=FALSE, echo = FALSE}
sf_crime %>% summarise(n_ids = n_distinct(PdId), 
                       n_crime_category = n_distinct(Category),
                       n_description    = n_distinct(Descript),
                       n_district       = n_distinct(PdDistrict),
                       n_resolution     = n_distinct(Resolution),
                       n_address        = n_distinct(Address), .groups = 'drop') %>% knitr::kable("pipe")
```

# Visualisation

##  District 
The occurrence of crime by 10 different districts shows that by far the most criminal district is Southern district followed by Northern and Mission. Park district shows the least crime occurrence with 8699 incidents for 2016.
```{r echo=FALSE, message=FALSE}
#   Number of crime occurrences for each district
sf_crime %>% group_by(PdDistrict) %>% 
  summarize(count=n())%>%
  ggplot(aes(x= reorder(PdDistrict, count), y = count))+
  geom_bar(stat='identity', alpha=.5, color = "black", fill = "red")+
  scale_fill_continuous(type = "viridis") +
  ggtitle("Occurrence of Crime by District") +
  coord_flip(y=c(0, 30000))+
  labs(x="District", y="Number of Crime Occurrences")+
  geom_text(aes(label= count), hjust=-0.1, size=3) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Category 
The variable *Category* is a factor variable with 39 different levels. 
```{r}
# Crime Category
class(sf_crime$Category)
nlevels(sf_crime$Category)
print(unique(sf_crime$Category))
```
Following categories are the top 10 of total 39 categories. "LARCENY/THEFT" accounts for the most cases.
```{r}
# Top 10 crimes with the greatest number of occurrence
sf_crime %>% group_by(Category)%>%
  summarize(count = n()) %>% arrange(desc(count)) %>% 
  top_n(10, count) %>% knitr::kable()
```

```{r echo=FALSE, message=FALSE}
# TOP 10 most frequent Crimes by Category
sf_crime %>%group_by(Category) %>% 
  summarize(count=n()) %>% arrange(desc(count)) %>% top_n(10, count) %>%
  ggplot(aes(x = reorder(Category, -count), y = count)) +
  geom_bar(stat="identity", alpha=.5, color="black", fill= "blue") + theme_bw()+
  ggtitle("TOP 10 Crimes by Category") +
  labs(x = "Category", y = "Number of Occurrences")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Weekdays